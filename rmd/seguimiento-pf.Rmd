---
title: "Seguimiento PF"
author: "Arthur Benitez"
date: "26/9/2019"
output: powerpoint_presentation
params:
  negocios: "'BODEGA','BAE'"
  old_nbrs: 4007408, 4225344
  wk_ini_stud: 11930
  wk_fin_stud: 11935
  wk_ini_vtas: 11926
  wk_fin_vtas: 11929
  user: 'user'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r run_queries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
# Correr los queries
prepare_queries <- function(query, params) {
  query %>% 
    str_replace_all('\\?NEGOCIOS', params$negocios) %>%
    str_replace_all('\\?OLD_NBRS', params$old_nbrs) %>%
    str_replace_all('\\?WK_INI_STUD', as.character(params$wk_ini_stud)) %>%
    str_replace_all('\\?WK_FIN_STUD', as.character(params$wk_fin_stud)) %>%
    str_replace_all('\\?WK_INI_VTAS', as.character(params$wk_ini_vtas)) %>%
    str_replace_all('\\?WK_FIN_VTAS', as.character(params$wk_fin_vtas)) %>%
    str_subset('^\\s*--', negate = TRUE) %>%  #quitar lineas de comentarios
    stringi::stri_trans_general('ASCII') %>% # quitar no ASCII porque truena en producci√≥n
    paste(collapse = '\n')
}

bines <- c('DDV00_IG_000', 'DDV01_MN_003', 'DDV02_MN_007', 'DDV03_MN_014', 'DDV04_MN_021', 'DDV05_MN_028', 'DDV06_MN_035', 'DDV07_MN_050', 'DDV08_MN_075', 'DDV09_MN_100', 'DDV10_MN_150', 'DDV11_MN_250', 'DDV12_MN_350', 'DDV13_MN_450', 'DDV14_MY_450')

queries <- list(
  ddv = readLines('../sql/item-business-week-ddv.sql'),
  is = readLines('../sql/item-business-week-is.sql'),
  sales = readLines('../sql/item-business-week-sales.sql')
  ) %>%
  map(~prepare_queries(.x, params))

ch <- RODBC::odbcDriverConnect(sprintf("Driver={Teradata};DBCName=WM3;AUTHENTICATION=ldap;AUTHENTICATIONPARAMETER=%s@@%s", params$user, rstudioapi::askForPassword('Password')))

res <- map(
  queries,
  function(x){
    RODBC::sqlQuery(ch, x, stringsAsFactors = FALSE) %>% 
      as_tibble() %>% 
      set_names(tolower(names(.)))
  })

res$ddv <- res$ddv %>% 
      complete(
        prime_xref_item_nbr,
        negocio,
        wm_yr_wk,
        repl_group_nbr,
        bin = bines,
        fill = list(
          oh = 0,
          sales = 0,
          ddv_oh = 0,
          n_stores = 0
        )
      )
```

```{r graphs}
library(ggplot2)

graph_ddv <- res$ddv %>% 
  ggplot(aes(wm_yr_wk)) +
  geom_col(aes(y = n_stores, fill = bin))

metrics <- res$is %>% 
  left_join(
    res$sales %>% 
      select(-c(cid, old_nbr)),
    by = c(
      'item_nbr' = 'prime_xref_item_nbr',
      'formato' = 'negocio',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  mutate(
    scaled_sales = scales::rescale(
      wkly_qty,
      to = c(
        min(c(is_oh, is_ttl)) * 100,
        max(c(is_oh, is_ttl)) * 100
      )
    )
  ) %>% 
  select(
    vp,
    division,
    dep_nbr,
    category_nbr,
    cid,
    item_nbr,
    old_nbr,
    primary_desc,
    sell_price,
    everything()
  )

graph_metrics <- metrics %>% 
  ggplot(aes(x = wm_yr_wk)) + 
  geom_line(aes(y = is_oh * 100, colour = 'In Stock OH')) + 
  geom_line(aes(y = is_ttl * 100, colour = 'In Stock Total')) + 
  geom_line(aes(y = scaled_sales, colour = 'Ventas')) + 
  geom_point(aes(y = is_oh * 100, colour = 'In Stock OH')) + 
  geom_point(aes(y = is_ttl * 100, colour = 'In Stock Total')) + 
  geom_point(aes(y = scaled_sales, colour = 'Ventas')) + 
  # ggtitle("Indicadores durante la estrategia") + 
  scale_y_continuous(
    sec.axis = sec_axis(
      ~scales::rescale(
        .,
        to = c(min(metrics$wkly_qty), max(metrics$wkly_qty))
      ),
      name = 'Piezas'
    )
  ) + 
  scale_color_hue() + 
  labs(
    title = 'Indicadores durante la estrategia',
    x = 'Semanas Walmart',
    y = 'Porcentaje (%)',
    colour = 'Indicador'
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = 'bottom'
  )
```

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Output

```{r cars, echo = TRUE}
summary(cars)
```

## Slide with Plot

```{r pressure}
plot(pressure)
```

