---
output:
  html_document:
    toc: TRUE
    toc_depth: 3
    toc_float:
      collapsed: FALSE
      smooth_scroll: TRUE
      number_sections: TRUE
params:
  negocios: "'BODEGA','BAE'"
  old_nbrs: 4007408, 9574857
  wk_ini_stud: 11930
  wk_fin_stud: 11935
  wk_ini_vtas: 11926
  wk_fin_vtas: 11929
  user: 'user'
  password: 'password'
  run_queries: FALSE
---

<style type="text/css">
div.main-container {
  max-width: 100%;
  margin: 0px 0px 0px 0px;
  padding: 0px 0px 0px 0px;
}
#TOC {width: 10%;}
.col-md-3 {width: 10%;}
.col-md-9 {width: 90%;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(tidyverse)
library(ggplot2)
library(plotly)
library(kableExtra)
```

```{r run_queries, eval=params$run_queries, message=FALSE, warning=FALSE, include=FALSE}
prepare_queries <- function(query, params) {
  query %>% 
    str_replace_all('\\?NEGOCIOS', params$negocios) %>%
    str_replace_all('\\?OLD_NBRS', paste(params$old_nbrs, collapse = ',')) %>%
    str_replace_all('\\?WK_INI_STUD', as.character(params$wk_ini_stud)) %>%
    str_replace_all('\\?WK_FIN_STUD', as.character(params$wk_fin_stud)) %>%
    str_replace_all('\\?WK_INI_VTAS', as.character(params$wk_ini_vtas)) %>%
    str_replace_all('\\?WK_FIN_VTAS', as.character(params$wk_fin_vtas)) %>%
    str_subset('^\\s*--', negate = TRUE) %>%  #quitar lineas de comentarios
    stringi::stri_trans_general('ASCII') %>% # quitar no ASCII porque truena en producción
    paste(collapse = '\n')
}

queries <- list(
  ddv = readLines('../sql/item-business-week-ddv.sql'),
  is = readLines('../sql/item-business-week-is.sql'),
  sales = readLines('../sql/item-business-week-sales.sql'),
  stats = readLines('../sql/item-business-week-statistics.sql')
  ) %>%
  map(~prepare_queries(.x, params))

ch <- RODBC::odbcDriverConnect(sprintf("Driver={Teradata};DBCName=WM3;AUTHENTICATION=ldap;AUTHENTICATIONPARAMETER=%s@@%s", params$user, params$password))

res <- map(
  queries,
  function(x){
    RODBC::sqlQuery(ch, x, stringsAsFactors = FALSE) %>% 
      as_tibble() %>% 
      set_names(tolower(names(.)))
  })
write_rds(res, '../rmd/queries-res.rds')
```

```{r read_info, eval=!params$run_queries, message=FALSE, warning=FALSE, include=FALSE}
res <- read_rds('../rmd/queries-res.rds')
```

```{r metrics_calc, message=FALSE, warning=FALSE, include=FALSE}
metrics_info <- res$is %>% 
  left_join(
    res$sales %>% 
      select(-c(cid, old_nbr)),
    by = c(
      'item_nbr' = 'prime_xref_item_nbr',
      'formato' = 'negocio',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    vp,
    division,
    dep_nbr,
    category_nbr,
    cid,
    item_nbr,
    old_nbr,
    item1_desc,
    sell_price,
    everything()
  )

metrics_plot <- function(data, keys){
  data %>% 
    mutate(
      scaled_sales = scales::rescale(
        wkly_qty,
        to = c(
          min(c(is_oh, is_ttl)) - 0.01,
          max(c(is_oh, is_ttl)) + 0.01
        )
      )
    ) %>% 
    ggplot(aes(x = wm_yr_wk)) + 
    geom_line( aes(y = is_oh,        colour = 'In Stock OH'    ), size = 1) + 
    geom_line( aes(y = is_ttl,       colour = 'In Stock Cadena'), size = 1) + 
    geom_line( aes(y = scaled_sales, colour = 'Ventas'         ), size = 1) + 
    geom_point(aes(y = is_oh,        colour = 'In Stock OH'    ), size = 2) + 
    geom_point(aes(y = is_ttl,       colour = 'In Stock Cadena'), size = 2) + 
    geom_point(aes(y = scaled_sales, colour = 'Ventas'         ), size = 2) + 
    scale_y_continuous(
      labels = scales::percent_format(accuracy = 0.1),
      sec.axis = sec_axis(
        ~scales::rescale(
          .,
          to = c(min(data$wkly_qty), max(data$wkly_qty))
        ),
        name = 'Piezas',
        labels = scales::comma
      )
    ) + 
    ggthemes::scale_color_colorblind() + 
    labs(
      title = apply(keys, 1, paste, collapse = ' - '),
      x = 'Semanas Walmart',
      y = 'Porcentaje (%)',
      colour = ''
    ) + 
    theme(
      plot.title = element_text(hjust = 0.5),
      legend.position = 'bottom'
    )
}

## Preparación de info por item-negocio
graph_metrics_ind <- metrics_info %>% 
  group_by(item_nbr, item1_desc, formato) %>% 
  group_map(~metrics_plot(.x, .y))

## Grid por item-negocio
grids_metrics_ind <- gridExtra::marrangeGrob(
  grobs = graph_metrics_ind,
  nrow = 2,
  ncol = 2,
  top =  ''
)

## Preparación de info por categoría-negocio
metrics_sum <- metrics_info %>% 
  group_by(dep_nbr, category_nbr, category_name, formato, wm_yr_wk) %>% 
  summarise(
    vp = first(vp),
    division = first(division),
    sell_price = sum(sell_price * wkly_qty, na.rm = TRUE) / sum(wkly_qty, na.rm = TRUE),
    catalogo = sum(catalogo),
    falt_oh = sum(falt_oh),
    falt_oh_it = sum(falt_oh_it),
    falt_oh_iw = sum(falt_oh_it_iw),
    falt_ttl = sum(falt_ttl),
    is_oh = 1 - (falt_oh / catalogo),
    is_ttl = 1 - (falt_ttl / catalogo),
    wkly_qty = sum(wkly_qty)
  ) %>% 
  ungroup

## Gráfica por categoría-negocio
graph_metrics_sum <- metrics_sum %>% 
  group_by(dep_nbr, category_nbr, category_name, formato) %>% 
  group_map(~metrics_plot(.x, .y))

## Grid por categoría-negocio
grids_metrics_sum <- gridExtra::marrangeGrob(
  grobs = graph_metrics_sum,
  nrow = 2,
  ncol = 2,
  top =  ''
)
```

```{r box_calc, message=FALSE, warning=FALSE, include=FALSE}
box_info <- res$stats  %>% 
  left_join(
    y = res$is,
    by = c(
      'prime_xref_item_nbr' = 'item_nbr',
      'negocio' = 'formato',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    prime_xref_item_nbr,
    negocio,
    wm_yr_wk,
    dep_nbr,
    category,
    category_name,
    repl_group_nbr,
    item1_desc,
    oh,
    sales,
    ddv_oh,
    n_stores,
    ddv_oh_avg,
    perc_00,
    perc_25,
    perc_50,
    perc_75,
    perc_100
  ) %>% 
  mutate(
    category_name = ifelse(is.na(category_name), 'Unspecified', category_name),
    iqr = perc_75 - perc_25,
    up_whisk = perc_75 + 1.5 * iqr,
    low_whisk = ifelse(perc_25 - 1.5 * iqr < 0, 0, perc_25 - 1.5 * iqr)
  )

box_plot <- function(data, keys){
  label_values <- data %>% 
    select(wm_yr_wk, ddv_oh, low_whisk, perc_25, perc_50, perc_75, up_whisk) %>% 
    mutate_at(vars(-wm_yr_wk), round) %>% 
    gather(key = 'label', value = 'percentile', -wm_yr_wk)
  data %>% 
    ggplot(
      aes(
        x = wm_yr_wk,
        ymin = ifelse(perc_00 == perc_25, perc_00, low_whisk),
        lower = perc_25,
        middle = perc_50,
        upper = perc_75,
        ymax = ifelse(perc_100 == perc_75, perc_100, up_whisk)
      )
    ) + 
    geom_errorbar(width = 0.4, size = 0.8) + 
    geom_boxplot(stat = 'identity', size = 1, width = 0.4) + 
    geom_point(aes(y = ddv_oh), size = 3, color = 'blue') + 
    annotate(
      geom = 'text',
      x = label_values$wm_yr_wk + 0.3,
      y = label_values$percentile,
      label = label_values$percentile
    ) + 
    labs(
      title = apply(keys, 1, paste, collapse = ' - '),
      x = 'Semanas Walmart',
      y = 'DDV'
    ) + 
    theme(plot.title = element_text(hjust = 0.5))
}

## Preparación de info por item-negocio
graph_box_ind <- box_info  %>% 
  group_by(prime_xref_item_nbr, item1_desc, negocio) %>% 
  group_map(~box_plot(.x, .y))

## Grid por item-negocio
grids_box_ind <- gridExtra::marrangeGrob(
  grobs = graph_box_ind,
  nrow = 2,
  ncol = 2,
  top =  ''
)

## Preparación de info por categoría-negocio
box_sum <- box_info  %>%
  group_by(category, negocio, wm_yr_wk) %>%
  summarise(
    category_name = first(category_name),
    oh = sum(oh),
    sales = sum(sales),
    ddv_oh = ifelse(sales <= 0, 1000, oh / (sales / 7)),
    n_stores = sum(n_stores),
    ddv_oh_avg = mean(ddv_oh_avg),
    perc_00 = mean(perc_00),
    perc_25 = mean(perc_25),
    perc_50 = mean(perc_50),
    perc_75 = mean(perc_75),
    perc_100 = mean(perc_100),
    iqr = perc_75 - perc_25,
    up_whisk = perc_75 + 1.5 * iqr,
    low_whisk = ifelse(perc_25 - 1.5 * iqr < 0, 0, perc_25 - 1.5 * iqr)
  ) %>% 
  ungroup

## Gráfica por categoría-negocio
graph_box_sum <- box_sum %>% 
  group_by(category, category_name, negocio) %>% 
  group_map(~box_plot(.x, .y))

## Grid por categoría-negocio
grids_box_sum <- gridExtra::marrangeGrob(
  grobs = graph_box_sum,
  nrow = 2,
  ncol = 2,
  top =  ''
)
```

```{r bins_calc, message=FALSE, warning=FALSE, include=FALSE}
bines <- c('DDV00_IG_000', 'DDV01_MN_003', 'DDV02_MN_007', 'DDV03_MN_014', 'DDV04_MN_021', 'DDV05_MN_028', 'DDV06_MN_035', 'DDV07_MN_050', 'DDV08_MN_075', 'DDV09_MN_100', 'DDV10_MN_150', 'DDV11_MN_250', 'DDV12_MN_350', 'DDV13_MN_450', 'DDV14_MY_450')

bins_info <- res$ddv %>% 
  left_join(
    y = res$is,
    by = c(
      'prime_xref_item_nbr' = 'item_nbr',
      'negocio' = 'formato',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    prime_xref_item_nbr,
    negocio,
    wm_yr_wk,
    repl_group_nbr,
    item1_desc,
    dep_nbr,
    category,
    category_name,
    cost,
    bin,
    oh,
    sales,
    ddv_oh,
    n_stores
  ) %>% 
  mutate(
    category_name = ifelse(is.na(category_name), 'Unspecified', category_name),
    bin = as.factor(bin),
    cost_oh = cost * oh
  )

bins_plotly <- function(data, keys){
  data %>% 
    plot_ly(
      x = ~as.character(wm_yr_wk),
      y = ~n_stores,
      type = 'bar',
      color = ~bin,
      colors = c(ggthemes::colorblind_pal()(8), 'darkblue', 'gray30', '#ff05c5', 'gray70', 'darkgreen', 'gray 90', '#f27979'),
      hoverinfo = 'text',
      text = ~sprintf(
        '%s<br>Tiendas: %s<br>Piezas OH: %s<br>Costo OH: $%s',
        bin, n_stores, scales::comma(oh), scales::comma(cost_oh)
      ),
      showlegend = (keys$group_id %% 2 == 1),
      legendgroup = ~bin
    ) %>% 
    layout(
      annotations = list(
        x = ifelse(keys$group_id %% 2 == 1, 0.3, 0.7),
        y = 1,
        text = apply(
          keys[, !(names(keys) == 'group_id')], 1, paste, collapse = ' - '),
        showarrow = F, xref = 'paper', yref = 'paper'
      ),
      xaxis = list(title = 'Semanas WM'),
      yaxis = list(title = 'Número de tiendas'),
      barmode = 'stack',
      legend = list(traceorder = 'reversed')
    )
}

## Preparación de info por item-negocio
graph_ddv_ind <- bins_info  %>% 
  mutate(group_id = group_indices(., prime_xref_item_nbr, item1_desc, negocio)) %>% 
  group_by(prime_xref_item_nbr, item1_desc, negocio, group_id) %>% 
  complete(
    wm_yr_wk,
    bin = bines,
    fill = list(
      oh = 0,
      cost_oh = 0,
      sales = 0,
      ddv_oh = 0,
      n_stores = 0
    )
  ) %>% 
  group_map(~bins_plotly(.x, .y))

## Grid por item-negocio
grids_bins_ind <- graph_ddv_ind %>% 
  split(ceiling(seq_along(.)/2)) %>% 
  lapply(subplot, titleX = TRUE, titleY = TRUE)

## Preparación de info por categoría-negocio
graph_ddv_sum <- bins_info  %>%
  group_by(dep_nbr, category, category_name, negocio, wm_yr_wk, bin) %>% 
  summarise(
    oh = sum(oh),
    cost_oh = sum(cost_oh),
    sales = sum(sales),
    ddv_oh = ifelse(sales <= 0, 1000, oh / (sales / 7)),
    n_stores = sum(n_stores)
  ) %>% 
  ungroup() %>% 
  mutate(group_id = group_indices(., category, negocio)) %>% 
  group_by(dep_nbr, category, category_name, negocio, group_id) %>% 
  complete(
    wm_yr_wk,
    bin = bines,
    fill = list(
      oh = 0,
      cost_oh = 0,
      sales = 0,
      ddv_oh = 0,
      n_stores = 0
    )
  ) %>% 
  group_map(~bins_plotly(.x, .y))

## Grid por categoria-negocio
grids_bins_sum <- graph_ddv_sum %>% 
  split(ceiling(seq_along(.)/2)) %>% 
  lapply(subplot, titleX = TRUE, titleY = TRUE)
```

```{r sum_calc, echo=FALSE, message=FALSE, warning=FALSE}
tonum <- function(percentage){
  return(as.numeric(sub('%', '', percentage)))
}

create_table <- function(data, wmwk1, wmwk2, objects, cat_flag){
  rep_cols <- c(paste('WMWK ', wmwk1), paste('WMWK ', wmwk2), 'Diferencia')
  pretty_names <- c(ifelse(cat_flag, 'Categoría', 'Artículo'), 'Descripción', 'Formato', rep.int(rep_cols, 3))
  
  data %>% 
    mutate_at(vars(one_of(c(as.character(objects$is_oh_1), as.character(objects$is_oh_2)))), scales::percent, accuracy = 0.1) %>%
    mutate_at(vars(one_of(c(as.character(objects$wkly_qty1), as.character(objects$wkly_qty2)))), scales::comma) %>% 
    mutate_at(vars(one_of(c(as.character(objects$ddv_oh_1), as.character(objects$ddv_oh_2)))), scales::comma, accuracy = 0.1) %>% 
    mutate(
      is_oh_dif = scales::percent(is_oh_dif, accuracy = 0.01, prefix = ifelse(is_oh_dif > 0, '+', '')),
      ddv_oh_dif = scales::percent(ddv_oh_dif, accuracy = 0.01, prefix = ifelse(ddv_oh_dif > 0, '+', '')),
      wkly_qty_dif = scales::percent(wkly_qty_dif, accuracy = 0.01, prefix = ifelse(wkly_qty_dif > 0, '+', ''))
    ) %>% 
    mutate(
      is_oh_dif = cell_spec(is_oh_dif, 'html', color = ifelse(tonum(is_oh_dif) < 0, 'red', ifelse(tonum(is_oh_dif) > 0, '#35a15c', 'black'))),
      wkly_qty_dif = cell_spec(wkly_qty_dif, 'html', color = ifelse(tonum(wkly_qty_dif) < 0, 'red', ifelse(tonum(wkly_qty_dif) > 0, '#35a15c', 'black'))),
      ddv_oh_dif = cell_spec(ddv_oh_dif, 'html', color = ifelse(tonum(ddv_oh_dif) < 0, '#35a15c', ifelse(tonum(ddv_oh_dif) > 0, 'red', 'black')))
    ) %>% 
    set_names(pretty_names) %>% 
    kable(format = "html", escape = FALSE, align = 'c') %>% 
    kable_styling(
      bootstrap_options = c('striped', 'hover', 'condensed'),
      full_width = TRUE,
      font_size = 15,
      fixed_thead = list(enabled = TRUE)
    ) %>% 
    row_spec(0, color = '#FFFFFF', background = '#0071ce') %>% 
    column_spec(c(3, 6, 9), border_right = T) %>% 
    column_spec(c(6, 9, 12), bold = TRUE) %>% 
    add_header_above(c(
      'Llaves de combinación' = 3,
      'In Stock' = 3,
      'Ventas semanales (Piezas)' = 3,
      'Días de Venta' = 3
    ))
}

wmwk1 <- min(metrics_info$wm_yr_wk) 
wmwk2 <- max(metrics_info$wm_yr_wk)
objects <- list(
  is_oh_1 = rlang::sym(paste('is_oh', wmwk1, sep = '_')),
  is_oh_2 = rlang::sym(paste('is_oh', wmwk2, sep = '_')),
  ddv_oh_1 = rlang::sym(paste('ddv_oh', wmwk1, sep = '_')),
  ddv_oh_2 = rlang::sym(paste('ddv_oh', wmwk2, sep = '_')),
  wkly_qty1 = rlang::sym(paste('wkly_qty', wmwk1, sep = '_')),
  wkly_qty2 = rlang::sym(paste('wkly_qty', wmwk2, sep = '_')) 
)

item_info <- metrics_info %>% 
  left_join(
    y = box_info %>% 
      select(-item1_desc),
    by = c(
      'item_nbr' = 'prime_xref_item_nbr',
      'formato' = 'negocio',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    item_nbr,
    formato,
    item1_desc,
    wm_yr_wk,
    is_oh,
    wkly_qty,
    ddv_oh
  ) %>% 
  filter(wm_yr_wk %in% c(wmwk1, wmwk2)) %>% 
  gather(variable, value, -(item_nbr:wm_yr_wk)) %>% 
  unite(temp, variable, wm_yr_wk) %>% 
  spread(temp, value) %>% 
  mutate(
    is_oh_dif = (!!objects$is_oh_2 - !!objects$is_oh_1) / !!objects$is_oh_1,
    ddv_oh_dif = (!!objects$ddv_oh_2 - !!objects$ddv_oh_1) / !!objects$ddv_oh_1,
    wkly_qty_dif = (!!objects$wkly_qty2 - !!objects$wkly_qty1) / !!objects$wkly_qty1
  ) %>% 
  select(
    item_nbr,
    item1_desc,
    formato,
    starts_with('is_oh'),
    starts_with('wkly_qty'),
    everything()
  )

cat_info <- metrics_sum %>% 
  left_join(
    y = box_sum %>% 
      select(-category_name),
    by = c(
      'category_nbr' = 'category',
      'formato' = 'negocio',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    category_nbr,
    formato,
    category_name,
    wm_yr_wk,
    is_oh,
    wkly_qty,
    ddv_oh
  ) %>% 
  filter(wm_yr_wk %in% c(wmwk1, wmwk2)) %>% 
  gather(variable, value, -(category_nbr:wm_yr_wk)) %>% 
  unite(temp, variable, wm_yr_wk) %>% 
  spread(temp, value) %>% 
  mutate(
    is_oh_dif = (!!objects$is_oh_2 - !!objects$is_oh_1) / !!objects$is_oh_1,
    ddv_oh_dif = (!!objects$ddv_oh_2 - !!objects$ddv_oh_1) / !!objects$ddv_oh_1,
    wkly_qty_dif = (!!objects$wkly_qty2 - !!objects$wkly_qty1) / !!objects$wkly_qty1
  ) %>% 
  select(
    category_nbr,
    category_name,
    formato,
    starts_with('is_oh'),
    starts_with('wkly_qty'),
    everything()
  )

item_table <- item_info %>% 
  create_table(wmwk1 = wmwk1, wmwk2 = wmwk2, objects = objects, cat_flag = FALSE)

cat_table <- cat_info %>% 
  create_table(wmwk1 = wmwk1, wmwk2 = wmwk2, objects = objects, cat_flag = TRUE)
```

# Inicio

Reporte de Seguimiento de [Promo Fulfillment](https://ml.prod.walmart.com:31705/v1/deployment/shiny_2915_3966/)

[Replenishment Data Science MX](mailto:Replenishment Data Science MX <replen_ds_mx@email.wal-mart.com>
  ?subject=Promo Fulfillment&body=Usuario:    [Escribe tu usuario de Windows]%0A%0AMotivo:    [Selecciona a qué tema pertenece tu duda de entre estas opciones: Duda/Error/Solicitud/Capacitación/Otro]%0A%0ADetalles:    [Describe brevemente la situación o adjunta ejemplos/evidencia])

`r Sys.Date()`

Reporte de IS, Ventas y Dispersión.

Este reporte fue generado automáticamente.

# Resumen {.tabset .tabset-fade .tabset-pills}

Estas tablas muestra la evolución de los indicadores clave entre la primera y última semana del estudio.

## Item-Formato

```{r tbl_ind, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
item_table
```

## Categoría-Formato

```{r tbl_sum, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
cat_table
```

# IS / Ventas {.tabset .tabset-fade .tabset-pills}

## Item-Formato

Indicadores durante la estrategia, calculados al cierre de las semanas Walmart.

```{r metrics_ind, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_metrics_ind
```

## Categoría-Formato

Indicadores durante la estrategia, calculados al cierre de las semanas Walmart.

```{r metrics_sum, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_metrics_sum
```

# Dispersión

## Boxplot {.tabset .tabset-fade .tabset-pills}

### Item-Formato

Dispersión durante la estrategia.

```{r box_ind, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_box_ind
```

### Categoría-Formato

Los percentiles aquí resumidos se calcularon usando el promedio de los percentiles de la base item-formato, por lo que no representan los percentiles reales del conjunto de tiendas agrupadas al nivel de resumen visto. Por ello, estas gráficas son aproximaciones y con objetivo méramente visual.

```{r box_sum, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_box_sum
```

## Bines {.tabset .tabset-fade .tabset-pills}

### Item-Formato

Esta gráfica muestra la cantidad de tiendas que se clasifican en cada uno de los bines de acuerdo a los DDV OH que presentaron en cada semana.

```{r bins_ind, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
htmltools::tagList(grids_bins_ind)
```

### Categoría-Formato

Esta gráfica muestra la cantidad de tiendas que se clasifican en cada uno de los bines de acuerdo a los DDV OH que presentaron en cada semana.

```{r bins_sum, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
htmltools::tagList(grids_bins_sum)
```
