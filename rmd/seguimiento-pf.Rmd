---
output: slidy_presentation
params:
  negocios: "'BODEGA','BAE'"
  old_nbrs: 4007408, 9574857
  wk_ini_stud: 11930
  wk_fin_stud: 11935
  wk_ini_vtas: 11926
  wk_fin_vtas: 11929
  user: 'user'
  password: 'password'
  run_queries: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggplot2)
```

```{r run_queries, eval=params$run_queries, message=FALSE, warning=FALSE, include=FALSE}
prepare_queries <- function(query, params) {
  query %>% 
    str_replace_all('\\?NEGOCIOS', params$negocios) %>%
    str_replace_all('\\?OLD_NBRS', paste(params$old_nbrs, collapse = ',')) %>%
    str_replace_all('\\?WK_INI_STUD', as.character(params$wk_ini_stud)) %>%
    str_replace_all('\\?WK_FIN_STUD', as.character(params$wk_fin_stud)) %>%
    str_replace_all('\\?WK_INI_VTAS', as.character(params$wk_ini_vtas)) %>%
    str_replace_all('\\?WK_FIN_VTAS', as.character(params$wk_fin_vtas)) %>%
    str_subset('^\\s*--', negate = TRUE) %>%  #quitar lineas de comentarios
    stringi::stri_trans_general('ASCII') %>% # quitar no ASCII porque truena en producción
    paste(collapse = '\n')
}

queries <- list(
  ddv = readLines('../sql/item-business-week-ddv.sql'),
  is = readLines('../sql/item-business-week-is.sql'),
  sales = readLines('../sql/item-business-week-sales.sql'),
  stats = readLines('../sql/item-business-week-statistics.sql')
  ) %>%
  map(~prepare_queries(.x, params))

ch <- RODBC::odbcDriverConnect(sprintf("Driver={Teradata};DBCName=WM3;AUTHENTICATION=ldap;AUTHENTICATIONPARAMETER=%s@@%s", params$user, params$password))

res <- map(
  queries,
  function(x){
    RODBC::sqlQuery(ch, x, stringsAsFactors = FALSE) %>% 
      as_tibble() %>% 
      set_names(tolower(names(.)))
  })
write_rds(res, '../rmd/queries-res.rds')
```

```{r read_info, eval=!params$run_queries, message=FALSE, warning=FALSE, include=FALSE}
res <- read_rds('../rmd/queries-res.rds')
```

```{r metrics_calc, message=FALSE, warning=FALSE, include=FALSE}
metrics <- res$is %>% 
  left_join(
    res$sales %>% 
      select(-c(cid, old_nbr)),
    by = c(
      'item_nbr' = 'prime_xref_item_nbr',
      'formato' = 'negocio',
      'wm_yr_wk' = 'wm_yr_wk'
    )
  ) %>% 
  select(
    vp,
    division,
    dep_nbr,
    category_nbr,
    cid,
    item_nbr,
    old_nbr,
    primary_desc,
    sell_price,
    everything()
  )

graph_metrics <- metrics %>% 
  group_by(item_nbr, primary_desc, formato) %>% 
  group_map(~{
    .x %>% 
      mutate(
        scaled_sales = scales::rescale(
          wkly_qty,
          to = c(
            min(c(is_oh, is_ttl)),
            max(c(is_oh, is_ttl))
          )
        )
      ) %>% 
      ggplot(aes(x = wm_yr_wk)) + 
      geom_line( aes(y = is_oh,        colour = 'In Stock OH'    ), size = 1) + 
      geom_line( aes(y = is_ttl,       colour = 'In Stock Cadena'), size = 1) + 
      geom_line( aes(y = scaled_sales, colour = 'Ventas'         ), size = 1) + 
      geom_point(aes(y = is_oh,        colour = 'In Stock OH'    ), size = 2) + 
      geom_point(aes(y = is_ttl,       colour = 'In Stock Cadena'), size = 2) + 
      geom_point(aes(y = scaled_sales, colour = 'Ventas'         ), size = 2) + 
      scale_y_continuous(
        labels = scales::percent,
        sec.axis = sec_axis(
          ~scales::rescale(
            .,
            to = c(min(.x$wkly_qty), max(.x$wkly_qty))
          ),
          name = 'Piezas',
          labels = scales::comma
        )
      ) + 
      ggthemes::scale_color_colorblind() + 
      labs(
        title = sprintf('%s - %s', .y$item_nbr, .y$formato),
        x = 'Semanas Walmart',
        y = 'Porcentaje (%)',
        colour = 'Indicador',
        caption = sprintf('Item: %s.', .y$primary_desc)
      ) + 
      theme(
        plot.title = element_text(hjust = 0.5),
        legend.position = 'bottom'
      )
  })

grids_metrics <- gridExtra::marrangeGrob(
  grobs = graph_metrics,
  nrow = 2,
  ncol = 2,
  top =  ''
)
```

```{r box_calc, message=FALSE, warning=FALSE, include=FALSE}
box_info <- res$stats  %>% 
  mutate(
        wm_yr_wk = as.character(wm_yr_wk),
        iqr = perc_75 - perc_25,
        up_whisk = perc_75 + 1.5 * iqr,
        low_whisk = ifelse(perc_25 - 1.5 * iqr < 0, 0, perc_25 - 1.5 * iqr)
  )
  
graph_box <- box_info  %>% 
  group_by(prime_xref_item_nbr, negocio) %>% 
  group_map(~{
    .x %>% 
      ggplot(
        aes(
          x = wm_yr_wk,
          ymin = ifelse(perc_00 == perc_25, perc_00, low_whisk),
          lower = perc_25,
          middle = perc_50,
          upper = perc_75,
          ymax = ifelse(perc_100 == perc_75, perc_100, up_whisk)
        )
      ) + 
      geom_errorbar(
        width = 0.4,
        size = 1
      ) + 
      geom_boxplot(
        stat = 'identity',
        size = 1
      ) + 
      labs(
        title = sprintf('%s - %s', .y$prime_xref_item_nbr, .y$negocio),
        x = 'Semanas Walmart',
        y = 'DDV'
      ) + 
      theme(
        plot.title = element_text(hjust = 0.5)
      )
  })

grids_box <- gridExtra::marrangeGrob(
  grobs = graph_box,
  nrow = 2,
  ncol = 2,
  top =  ''
)
```

```{r bins_graph, eval=FALSE, include=FALSE}
bines <- c('DDV00_IG_000', 'DDV01_MN_003', 'DDV02_MN_007', 'DDV03_MN_014', 'DDV04_MN_021', 'DDV05_MN_028', 'DDV06_MN_035', 'DDV07_MN_050', 'DDV08_MN_075', 'DDV09_MN_100', 'DDV10_MN_150', 'DDV11_MN_250', 'DDV12_MN_350', 'DDV13_MN_450', 'DDV14_MY_450')

disp_bins <- res$ddv %>% 
      complete(
        prime_xref_item_nbr,
        negocio,
        wm_yr_wk,
        repl_group_nbr,
        bin = bines,
        fill = list(
          oh = 0,
          sales = 0,
          ddv_oh = 0,
          n_stores = 0
        )
      )

graph_ddv <- disp_bins %>% 
  ggplot(aes(wm_yr_wk)) +
  geom_col(aes(y = n_stores, fill = bin)) + 
  labs(
    title = 'Dispersión de DDV OH por semana',
    x = 'Semanas Walmart',
    y = 'Número de tiendas',
    fill = 'Rango de DDV OH'
  )

graph_ddv
```

## Reporte de Seguimiento [Promo Fulfillment](https://ml.prod.walmart.com:31705/v1/deployment/shiny_2915_3966/)
[Replenishment Data Science MX](mailto:Replenishment Data Science MX <replen_ds_mx@email.wal-mart.com>
  ?subject=Promo Fulfillment&body=Usuario:    [Escribe tu usuario de Windows]%0A%0AMotivo:    [Selecciona a qué tema pertenece tu duda de entre estas opciones: Duda/Error/Solicitud/Capacitación/Otro]%0A%0ADetalles:    [Describe brevemente la situación o adjunta ejemplos/evidencia])

`r Sys.Date()`

Reporte de IS, Ventas y Dispersión.

###### Este reporte fue generado automáticamente.

## IS/Ventas

Indicadores durante la estrategia, calculados al cierre de las semanas Walmart.

```{r metrics_sum, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_metrics
```

## Dispersión - Boxplot

Dispersión durante la estrategia.

```{r box_sum, echo=FALSE, fig.height=8, fig.width=19, message=FALSE, warning=FALSE}
grids_box
```
